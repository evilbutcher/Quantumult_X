/*
Check in for Surge by Neurogram

 - ç«™ç‚¹ç­¾åˆ°è„šæœ¬
 - æµé‡è¯¦æƒ…æ˜¾ç¤º
 - å¤šç«™ç­¾åˆ°æ”¯æŒ
 - å¤šç±»ç«™ç‚¹æ”¯æŒ

ä½¿ç”¨è¯´æ˜Žï¼šhttps://www.notion.so/neurogram/Check-in-0797ec9f9f3f445aae241d7762cf9d8b

å…³äºŽä½œè€…
Telegram: Neurogram
GitHub: Neurogram-R

â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

ã€æœºåœºç­¾åˆ°Cookieç‰ˆã€‘ä¿®æ”¹è‡ªNeurogram
Modified by evilbutcher

ã€ä»“åº“åœ°å€ã€‘https://github.com/evilbutcher/Quantumult_X/tree/masterï¼ˆæ¬¢è¿ŽstarðŸŒŸï¼‰

ã€BoxJsã€‘https://raw.githubusercontent.com/evilbutcher/Quantumult_X/master/evilbutcher.boxjs.json

ã€è‡´è°¢ã€‘
ä½¿ç”¨Chavyçš„Env.jsä¿®æ”¹äº†åŽŸè„šæœ¬ï¼Œæ”¯æŒQuantumult Xå’ŒLoonï¼Œå¹¶æ”¯æŒBoxJs

âš ï¸ã€å…è´£å£°æ˜Žã€‘
------------------------------------------
1ã€æ­¤è„šæœ¬ä»…ç”¨äºŽå­¦ä¹ ç ”ç©¶ï¼Œä¸ä¿è¯å…¶åˆæ³•æ€§ã€å‡†ç¡®æ€§ã€æœ‰æ•ˆæ€§ï¼Œè¯·æ ¹æ®æƒ…å†µè‡ªè¡Œåˆ¤æ–­ï¼Œæœ¬äººå¯¹æ­¤ä¸æ‰¿æ‹…ä»»ä½•ä¿è¯è´£ä»»ã€‚
2ã€ç”±äºŽæ­¤è„šæœ¬ä»…ç”¨äºŽå­¦ä¹ ç ”ç©¶ï¼Œæ‚¨å¿…é¡»åœ¨ä¸‹è½½åŽ 24 å°æ—¶å†…å°†æ‰€æœ‰å†…å®¹ä»Žæ‚¨çš„è®¡ç®—æœºæˆ–æ‰‹æœºæˆ–ä»»ä½•å­˜å‚¨è®¾å¤‡ä¸­å®Œå…¨åˆ é™¤ï¼Œè‹¥è¿åè§„å®šå¼•èµ·ä»»ä½•äº‹ä»¶æœ¬äººå¯¹æ­¤å‡ä¸è´Ÿè´£ã€‚
3ã€è¯·å‹¿å°†æ­¤è„šæœ¬ç”¨äºŽä»»ä½•å•†ä¸šæˆ–éžæ³•ç›®çš„ï¼Œè‹¥è¿åè§„å®šè¯·è‡ªè¡Œå¯¹æ­¤è´Ÿè´£ã€‚
4ã€æ­¤è„šæœ¬æ¶‰åŠåº”ç”¨ä¸Žæœ¬äººæ— å…³ï¼Œæœ¬äººå¯¹å› æ­¤å¼•èµ·çš„ä»»ä½•éšç§æ³„æ¼æˆ–å…¶ä»–åŽæžœä¸æ‰¿æ‹…ä»»ä½•è´£ä»»ã€‚
5ã€æœ¬äººå¯¹ä»»ä½•è„šæœ¬å¼•å‘çš„é—®é¢˜æ¦‚ä¸è´Ÿè´£ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºŽç”±è„šæœ¬é”™è¯¯å¼•èµ·çš„ä»»ä½•æŸå¤±å’ŒæŸå®³ã€‚
6ã€å¦‚æžœä»»ä½•å•ä½æˆ–ä¸ªäººè®¤ä¸ºæ­¤è„šæœ¬å¯èƒ½æ¶‰å«Œä¾µçŠ¯å…¶æƒåˆ©ï¼Œåº”åŠæ—¶é€šçŸ¥å¹¶æä¾›èº«ä»½è¯æ˜Žï¼Œæ‰€æœ‰æƒè¯æ˜Žï¼Œæˆ‘ä»¬å°†åœ¨æ”¶åˆ°è®¤è¯æ–‡ä»¶ç¡®è®¤åŽåˆ é™¤æ­¤è„šæœ¬ã€‚
7ã€æ‰€æœ‰ç›´æŽ¥æˆ–é—´æŽ¥ä½¿ç”¨ã€æŸ¥çœ‹æ­¤è„šæœ¬çš„äººå‡åº”è¯¥ä»”ç»†é˜…è¯»æ­¤å£°æ˜Žã€‚æœ¬äººä¿ç•™éšæ—¶æ›´æ”¹æˆ–è¡¥å……æ­¤å£°æ˜Žçš„æƒåˆ©ã€‚ä¸€æ—¦æ‚¨ä½¿ç”¨æˆ–å¤åˆ¶äº†æ­¤è„šæœ¬ï¼Œå³è§†ä¸ºæ‚¨å·²æŽ¥å—æ­¤å…è´£å£°æ˜Žã€‚

è‡ªè¡Œå†™cronï¼Œä¾‹å¦‚ 0 1 0 * * * https://raw.githubusercontent.com/evilbutcher/Quantumult_X/master/check_in/glados/checkin_env.js

*/
const $ = new Env("æœºåœºç­¾åˆ°");
$.autoLogout = true;

if (
  $.getdata("evil_checkintitle") != undefined &&
  $.getdata("evil_checkintitle") != ""
) {
  var acc = $.getdata("evil_checkintitle");
  accounts = acc.split("&");
} else {
  if ($.isNode()) {
    if (
      process.env.TITLE &&
      process.env.TITLE.split("&") &&
      process.env.TITLE.split("&").length > 0
    ) {
      accounts = process.env.TITLE.split("&");
      console.log(
        `\n==================è„šæœ¬æ‰§è¡Œæ¥è‡ª github action=====================\n`
      );
      console.log(
        `==================è„šæœ¬æ‰§è¡Œ-å›½é™…æ ‡å‡†æ—¶é—´(UTC)ï¼š${new Date().toLocaleString()}=====================\n`
      );
      console.log(
        `==================è„šæœ¬æ‰§è¡Œ- åŒ—äº¬æ—¶é—´(UTC+8)ï¼š${new Date(
          new Date().getTime() + 8 * 60 * 60 * 1000
        ).toLocaleString()}=====================\n`
      );
    } else {
      $.msg(
        "æœºåœºç­¾åˆ°",
        "",
        "è¯·åœ¨ BoxJs/Secrets æ£€æŸ¥æ ‡é¢˜å¡«å†™æ˜¯å¦æ­£ç¡®",
        "http://boxjs.com"
      );
    }
  }
}

if (
  $.getdata("evil_checkinlogin") != undefined &&
  $.getdata("evil_checkinlogin") != ""
) {
  var ur = $.getdata("evil_checkinlogin");
  urls = ur.split("&");
} else {
  if ($.isNode()) {
    if (
      process.env.URL &&
      process.env.URL.split("&") &&
      process.env.URL.split("&").length > 0
    ) {
      urls = process.env.URL.split("&");
    } else {
      $.msg(
        "æœºåœºç­¾åˆ°",
        "",
        "è¯·åœ¨ BoxJs/Secrets æ£€æŸ¥ç™»é™†é“¾æŽ¥å¡«å†™æ˜¯å¦æ­£ç¡®",
        "http://boxjs.com"
      );
    }
  }
}

if (
  $.getdata("evil_checkinemail") != undefined &&
  $.getdata("evil_checkinemail") != ""
) {
  var ema = $.getdata("evil_checkinemail");
  emails = ema.split("&");
} else {
  if ($.isNode()) {
    if (
      process.env.EMAIL &&
      process.env.EMAIL.split("&") &&
      process.env.EMAIL.split("&").length > 0
    ) {
      emails = process.env.EMAIL.split("&");
    } else {
      $.msg(
        "æœºåœºç­¾åˆ°",
        "",
        "è¯·åœ¨ BoxJs/Secrets æ£€æŸ¥é‚®ç®±å¡«å†™æ˜¯å¦æ­£ç¡®",
        "http://boxjs.com"
      );
    }
  }
}

if (
  $.getdata("evil_checkinpwd") != undefined &&
  $.getdata("evil_checkinpwd") != ""
) {
  var pwd = $.getdata("evil_checkinpwd");
  passwords = pwd.split("&");
} else {
  if ($.isNode()) {
    if (
      process.env.PASSWORD &&
      process.env.PASSWORD.split("&") &&
      process.env.PASSWORD.split("&").length > 0
    ) {
      passwords = process.env.PASSWORD.split("&");
    } else {
      $.msg(
        "æœºåœºç­¾åˆ°",
        "",
        "è¯·åœ¨ BoxJs/Secrets æ£€æŸ¥å¯†ç å¡«å†™æ˜¯å¦æ­£ç¡®",
        "http://boxjs.com"
      );
    }
  }
}

$.autoLogout = JSON.parse($.getdata("evil_autoLogout") || $.autoLogout);

function launch() {
  for (var i in accounts) {
    let title = accounts[i];
    let url = urls[i];
    let email = emails[i];
    let password = passwords[i];
    if ($.autoLogout) {
      let logoutPath =
        url.indexOf("auth/login") != -1 ? "user/logout" : "user/logout.php";
      var logouturl = {
        url: url.replace(/(auth|user)\/login(.php)*/g, "") + logoutPath,
      };
      console.log(logouturl);
      $.get(logouturl, function (error, response, data) {
        login(url, email, password, title);
      });
    } else {
      checkin(url, email, password, title);
    }
  }
  $.done();
}

launch();

function login(url, email, password, title) {
  let loginPath =
    url.indexOf("auth/login") != -1 ? "auth/login" : "user/_login.php";
  let table = {
    url: url.replace(/(auth|user)\/login(.php)*/g, "") + loginPath,
    body: `email=${email}&passwd=${password}&rumber-me=week`,
  };
  console.log(loginPath);
  $.post(table, function (error, response, data) {
    if (error) {
      console.log(error);
      $.msg(title + "ç™»å½•å¤±è´¥", JSON.stringify(error), "");
    } else {
      if (
        JSON.parse(data).msg.match(
          /é‚®ç®±æˆ–è€…å¯†ç é”™è¯¯|Mail or password is incorrect/
        )
      ) {
        console.log(response);
        $.msg(title + "é‚®ç®±æˆ–è€…å¯†ç é”™è¯¯", "", "");
      } else {
        checkin(url, email, password, title);
      }
    }
  });
}

function checkin(url, email, password, title) {
  let checkinPath =
    url.indexOf("auth/login") != -1 ? "user/checkin" : "user/_checkin.php";
  var checkinreqest = {
    url: url.replace(/(auth|user)\/login(.php)*/g, "") + checkinPath,
  };
  console.log(checkinreqest);
  $.post(checkinreqest, (error, response, data) => {
    if (error) {
      console.log(error);
      $.msg(title + "ç­¾åˆ°å¤±è´¥", JSON.stringify(error), "");
    } else {
      if (data.match(/\"msg\"\:/)) {
        dataResults(url, JSON.parse(data).msg, title);
      } else {
        login(url, email, password, title);
      }
    }
  });
}

function dataResults(url, checkinMsg, title) {
  let userPath = url.indexOf("auth/login") != -1 ? "user" : "user/index.php";
  var datarequest = {
    url: url.replace(/(auth|user)\/login(.php)*/g, "") + userPath,
  };
  console.log(datarequest);
  $.get(datarequest, (error, response, data) => {
    let resultData = "";
    let result = [];
    if (data.match(/theme\/malio/)) {
      let flowInfo = data.match(/trafficDountChat\s*\(([^\)]+)/);
      if (flowInfo) {
        let flowData = flowInfo[1].match(/\d[^\']+/g);
        let usedData = flowData[0];
        let todatUsed = flowData[1];
        let restData = flowData[2];
        result.push(`ä»Šæ—¥ï¼š${todatUsed}\nå·²ç”¨ï¼š${usedData}\nå‰©ä½™ï¼š${restData}`);
      }
      let userInfo = data.match(/ChatraIntegration\s*=\s*({[^}]+)/);
      if (userInfo) {
        let user_name = userInfo[1].match(/name.+'(.+)'/)[1];
        let user_class = userInfo[1].match(/Class.+'(.+)'/)[1];
        let class_expire = userInfo[1].match(/Class_Expire.+'(.+)'/)[1];
        let money = userInfo[1].match(/Money.+'(.+)'/)[1];
        result.push(
          `ç”¨æˆ·åï¼š${user_name}\nç”¨æˆ·ç­‰çº§ï¼šlv${user_class}\nä½™é¢ï¼š${money}\nåˆ°æœŸæ—¶é—´ï¼š${class_expire}`
        );
      }
      if (result.length != 0) {
        resultData = result.join("\n\n");
      }
    } else {
      let todayUsed = data.match(/>*\s*ä»Šæ—¥(å·²ç”¨|ä½¿ç”¨)*[^B]+/);
      if (todayUsed) {
        todayUsed = flowFormat(todayUsed[0]);
        result.push(`ä»Šæ—¥ï¼š${todayUsed}`);
      }
      let usedData = data.match(
        /(Used Transfer|>è¿‡åŽ»å·²ç”¨|>å·²ç”¨|>æ€»å·²ç”¨|\"å·²ç”¨)[^B]+/
      );
      if (usedData) {
        usedData = flowFormat(usedData[0]);
        result.push(`å·²ç”¨ï¼š${usedData}`);
      }
      let restData = data.match(
        /(Remaining Transfer|>å‰©ä½™æµé‡|>æµé‡å‰©ä½™|>å¯ç”¨|\"å‰©ä½™)[^B]+/
      );
      if (restData) {
        restData = flowFormat(restData[0]);
        result.push(`å‰©ä½™ï¼š${restData}`);
      }
      if (result.length != 0) {
        resultData = result.join("\n");
      }
    }
    let flowMsg = resultData == "" ? "æµé‡ä¿¡æ¯èŽ·å–å¤±è´¥" : resultData;
    $.msg(title, checkinMsg, flowMsg);
  });
}

function flowFormat(data) {
  data = data.replace(/\d+(\.\d+)*%/, "");
  let flow = data.match(/\d+(\.\d+)*\w*/);
  return flow[0] + "B";
}

// prettier-ignore
function Env(t,e){class s{constructor(t){this.env=t}send(t,e="GET"){t="string"==typeof t?{url:t}:t;let s=this.get;return"POST"===e&&(s=this.post),new Promise((e,i)=>{s.call(this,t,(t,s,o)=>{t?i(t):e(s)})})}get(t){return this.send.call(this.env,t)}post(t){return this.send.call(this.env,t,"POST")}}return new class{constructor(t,e){this.name=t,this.http=new s(this),this.data=null,this.dataFile="box.dat",this.logs=[],this.isMute=!1,this.logSeparator="\n",this.startTime=(new Date).getTime(),Object.assign(this,e),this.log("",`\ud83d\udd14${this.name}, \u5f00\u59cb!`)}isNode(){return"undefined"!=typeof module&&!!module.exports}isQuanX(){return"undefined"!=typeof $task}isSurge(){return"undefined"!=typeof $httpClient&&"undefined"==typeof $loon}isLoon(){return"undefined"!=typeof $loon}toObj(t,e=null){try{return JSON.parse(t)}catch{return e}}toStr(t,e=null){try{return JSON.stringify(t)}catch{return e}}getjson(t,e){let s=e;const i=this.getdata(t);if(i)try{s=JSON.parse(this.getdata(t))}catch{}return s}setjson(t,e){try{return this.setdata(JSON.stringify(t),e)}catch{return!1}}getScript(t){return new Promise(e=>{this.get({url:t},(t,s,i)=>e(i))})}runScript(t,e){return new Promise(s=>{let i=this.getdata("@chavy_boxjs_userCfgs.httpapi");i=i?i.replace(/\n/g,"").trim():i;let o=this.getdata("@chavy_boxjs_userCfgs.httpapi_timeout");o=o?1*o:20,o=e&&e.timeout?e.timeout:o;const[r,h]=i.split("@"),a={url:`http://${h}/v1/scripting/evaluate`,body:{script_text:t,mock_type:"cron",timeout:o},headers:{"X-Key":r,Accept:"*/*"}};this.post(a,(t,e,i)=>s(i))}).catch(t=>this.logErr(t))}loaddata(){if(!this.isNode())return{};{this.fs=this.fs?this.fs:require("fs"),this.path=this.path?this.path:require("path");const t=this.path.resolve(this.dataFile),e=this.path.resolve(process.cwd(),this.dataFile),s=this.fs.existsSync(t),i=!s&&this.fs.existsSync(e);if(!s&&!i)return{};{const i=s?t:e;try{return JSON.parse(this.fs.readFileSync(i))}catch(t){return{}}}}}writedata(){if(this.isNode()){this.fs=this.fs?this.fs:require("fs"),this.path=this.path?this.path:require("path");const t=this.path.resolve(this.dataFile),e=this.path.resolve(process.cwd(),this.dataFile),s=this.fs.existsSync(t),i=!s&&this.fs.existsSync(e),o=JSON.stringify(this.data);s?this.fs.writeFileSync(t,o):i?this.fs.writeFileSync(e,o):this.fs.writeFileSync(t,o)}}lodash_get(t,e,s){const i=e.replace(/\[(\d+)\]/g,".$1").split(".");let o=t;for(const t of i)if(o=Object(o)[t],void 0===o)return s;return o}lodash_set(t,e,s){return Object(t)!==t?t:(Array.isArray(e)||(e=e.toString().match(/[^.[\]]+/g)||[]),e.slice(0,-1).reduce((t,s,i)=>Object(t[s])===t[s]?t[s]:t[s]=Math.abs(e[i+1])>>0==+e[i+1]?[]:{},t)[e[e.length-1]]=s,t)}getdata(t){let e=this.getval(t);if(/^@/.test(t)){const[,s,i]=/^@(.*?)\.(.*?)$/.exec(t),o=s?this.getval(s):"";if(o)try{const t=JSON.parse(o);e=t?this.lodash_get(t,i,""):e}catch(t){e=""}}return e}setdata(t,e){let s=!1;if(/^@/.test(e)){const[,i,o]=/^@(.*?)\.(.*?)$/.exec(e),r=this.getval(i),h=i?"null"===r?null:r||"{}":"{}";try{const e=JSON.parse(h);this.lodash_set(e,o,t),s=this.setval(JSON.stringify(e),i)}catch(e){const r={};this.lodash_set(r,o,t),s=this.setval(JSON.stringify(r),i)}}else s=this.setval(t,e);return s}getval(t){return this.isSurge()||this.isLoon()?$persistentStore.read(t):this.isQuanX()?$prefs.valueForKey(t):this.isNode()?(this.data=this.loaddata(),this.data[t]):this.data&&this.data[t]||null}setval(t,e){return this.isSurge()||this.isLoon()?$persistentStore.write(t,e):this.isQuanX()?$prefs.setValueForKey(t,e):this.isNode()?(this.data=this.loaddata(),this.data[e]=t,this.writedata(),!0):this.data&&this.data[e]||null}initGotEnv(t){this.got=this.got?this.got:require("got"),this.cktough=this.cktough?this.cktough:require("tough-cookie"),this.ckjar=this.ckjar?this.ckjar:new this.cktough.CookieJar,t&&(t.headers=t.headers?t.headers:{},void 0===t.headers.Cookie&&void 0===t.cookieJar&&(t.cookieJar=this.ckjar))}get(t,e=(()=>{})){t.headers&&(delete t.headers["Content-Type"],delete t.headers["Content-Length"]),this.isSurge()||this.isLoon()?$httpClient.get(t,(t,s,i)=>{!t&&s&&(s.body=i,s.statusCode=s.status),e(t,s,i)}):this.isQuanX()?$task.fetch(t).then(t=>{const{statusCode:s,statusCode:i,headers:o,body:r}=t;e(null,{status:s,statusCode:i,headers:o,body:r},r)},t=>e(t)):this.isNode()&&(this.initGotEnv(t),this.got(t).on("redirect",(t,e)=>{try{const s=t.headers["set-cookie"].map(this.cktough.Cookie.parse).toString();this.ckjar.setCookieSync(s,null),e.cookieJar=this.ckjar}catch(t){this.logErr(t)}}).then(t=>{const{statusCode:s,statusCode:i,headers:o,body:r}=t;e(null,{status:s,statusCode:i,headers:o,body:r},r)},t=>e(t)))}post(t,e=(()=>{})){if(t.body&&t.headers&&!t.headers["Content-Type"]&&(t.headers["Content-Type"]="application/x-www-form-urlencoded"),t.headers&&delete t.headers["Content-Length"],this.isSurge()||this.isLoon())$httpClient.post(t,(t,s,i)=>{!t&&s&&(s.body=i,s.statusCode=s.status),e(t,s,i)});else if(this.isQuanX())t.method="POST",$task.fetch(t).then(t=>{const{statusCode:s,statusCode:i,headers:o,body:r}=t;e(null,{status:s,statusCode:i,headers:o,body:r},r)},t=>e(t));else if(this.isNode()){this.initGotEnv(t);const{url:s,...i}=t;this.got.post(s,i).then(t=>{const{statusCode:s,statusCode:i,headers:o,body:r}=t;e(null,{status:s,statusCode:i,headers:o,body:r},r)},t=>e(t))}}time(t){let e={"M+":(new Date).getMonth()+1,"d+":(new Date).getDate(),"H+":(new Date).getHours(),"m+":(new Date).getMinutes(),"s+":(new Date).getSeconds(),"q+":Math.floor(((new Date).getMonth()+3)/3),S:(new Date).getMilliseconds()};/(y+)/.test(t)&&(t=t.replace(RegExp.$1,((new Date).getFullYear()+"").substr(4-RegExp.$1.length)));for(let s in e)new RegExp("("+s+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?e[s]:("00"+e[s]).substr((""+e[s]).length)));return t}msg(e=t,s="",i="",o){const r=t=>{if(!t||!this.isLoon()&&this.isSurge())return t;if("string"==typeof t)return this.isLoon()?t:this.isQuanX()?{"open-url":t}:void 0;if("object"==typeof t){if(this.isLoon()){let e=t.openUrl||t["open-url"],s=t.mediaUrl||t["media-url"];return{openUrl:e,mediaUrl:s}}if(this.isQuanX()){let e=t["open-url"]||t.openUrl,s=t["media-url"]||t.mediaUrl;return{"open-url":e,"media-url":s}}}};this.isMute||(this.isSurge()||this.isLoon()?$notification.post(e,s,i,r(o)):this.isQuanX()&&$notify(e,s,i,r(o)));let h=["","==============\ud83d\udce3\u7cfb\u7edf\u901a\u77e5\ud83d\udce3=============="];h.push(e),s&&h.push(s),i&&h.push(i),console.log(h.join("\n")),this.logs=this.logs.concat(h)}log(...t){t.length>0&&(this.logs=[...this.logs,...t]),console.log(t.join(this.logSeparator))}logErr(t,e){const s=!this.isSurge()&&!this.isQuanX()&&!this.isLoon();s?this.log("",`\u2757\ufe0f${this.name}, \u9519\u8bef!`,t.stack):this.log("",`\u2757\ufe0f${this.name}, \u9519\u8bef!`,t)}wait(t){return new Promise(e=>setTimeout(e,t))}done(t={}){const e=(new Date).getTime(),s=(e-this.startTime)/1e3;this.log("",`\ud83d\udd14${this.name}, \u7ed3\u675f! \ud83d\udd5b ${s} \u79d2`),this.log(),(this.isSurge()||this.isQuanX()||this.isLoon())&&$done(t)}}(t,e)}
