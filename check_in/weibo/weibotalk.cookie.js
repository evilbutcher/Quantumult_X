/**********

  ðŸ¬ä¸»è¦ä½œè€…ï¼šEvilbutcher ï¼ˆç­¾åˆ°ã€cookieç­‰ä¸»ä½“é€»è¾‘ç¼–å†™ï¼‰
  ðŸ“•åœ°å€ï¼šhttps://github.com/evilbutcher/Quantumult_X/tree/master

  ðŸ¬æ¬¡è¦ä½œè€…: toulanboy ï¼ˆç»†èŠ‚å®Œå–„ï¼Œæ”¯æŒå¤šå¹³å°ï¼‰
  ðŸ“•åœ°å€ï¼šhttps://github.com/toulanboy/scripts

  ðŸ¬ å¦ï¼Œæ„Ÿè°¢@Seafunã€@jaychouã€@MEOWå¸®å¿™æµ‹è¯•åŠæä¾›å»ºè®®ã€‚

  evilbutcher:éžä¸“ä¸šäººå£«åˆ¶ä½œï¼Œå¤´ä¸€æ¬¡å†™ç­¾åˆ°è„šæœ¬ï¼Œæ„Ÿè°¢@æŸ æª¬ç²¾å¸®å¿™è°ƒè¯•ä»£ç ã€æ„Ÿè°¢@Seafunã€@jaychouã€@MEOWå¸®å¿™æµ‹è¯•åŠæä¾›å»ºè®®ï¼Œæ„Ÿè°¢@chavyleungæ¨¡ç‰ˆã€‚
  
âš ï¸ã€å…è´£å£°æ˜Žã€‘
------------------------------------------
1ã€æ­¤è„šæœ¬ä»…ç”¨äºŽå­¦ä¹ ç ”ç©¶ï¼Œä¸ä¿è¯å…¶åˆæ³•æ€§ã€å‡†ç¡®æ€§ã€æœ‰æ•ˆæ€§ï¼Œè¯·æ ¹æ®æƒ…å†µè‡ªè¡Œåˆ¤æ–­ï¼Œæœ¬äººå¯¹æ­¤ä¸æ‰¿æ‹…ä»»ä½•ä¿è¯è´£ä»»ã€‚
2ã€ç”±äºŽæ­¤è„šæœ¬ä»…ç”¨äºŽå­¦ä¹ ç ”ç©¶ï¼Œæ‚¨å¿…é¡»åœ¨ä¸‹è½½åŽ 24 å°æ—¶å†…å°†æ‰€æœ‰å†…å®¹ä»Žæ‚¨çš„è®¡ç®—æœºæˆ–æ‰‹æœºæˆ–ä»»ä½•å­˜å‚¨è®¾å¤‡ä¸­å®Œå…¨åˆ é™¤ï¼Œè‹¥è¿åè§„å®šå¼•èµ·ä»»ä½•äº‹ä»¶æœ¬äººå¯¹æ­¤å‡ä¸è´Ÿè´£ã€‚
3ã€è¯·å‹¿å°†æ­¤è„šæœ¬ç”¨äºŽä»»ä½•å•†ä¸šæˆ–éžæ³•ç›®çš„ï¼Œè‹¥è¿åè§„å®šè¯·è‡ªè¡Œå¯¹æ­¤è´Ÿè´£ã€‚
4ã€æ­¤è„šæœ¬æ¶‰åŠåº”ç”¨ä¸Žæœ¬äººæ— å…³ï¼Œæœ¬äººå¯¹å› æ­¤å¼•èµ·çš„ä»»ä½•éšç§æ³„æ¼æˆ–å…¶ä»–åŽæžœä¸æ‰¿æ‹…ä»»ä½•è´£ä»»ã€‚
5ã€æœ¬äººå¯¹ä»»ä½•è„šæœ¬å¼•å‘çš„é—®é¢˜æ¦‚ä¸è´Ÿè´£ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºŽç”±è„šæœ¬é”™è¯¯å¼•èµ·çš„ä»»ä½•æŸå¤±å’ŒæŸå®³ã€‚
6ã€å¦‚æžœä»»ä½•å•ä½æˆ–ä¸ªäººè®¤ä¸ºæ­¤è„šæœ¬å¯èƒ½æ¶‰å«Œä¾µçŠ¯å…¶æƒåˆ©ï¼Œåº”åŠæ—¶é€šçŸ¥å¹¶æä¾›èº«ä»½è¯æ˜Žï¼Œæ‰€æœ‰æƒè¯æ˜Žï¼Œæˆ‘ä»¬å°†åœ¨æ”¶åˆ°è®¤è¯æ–‡ä»¶ç¡®è®¤åŽåˆ é™¤æ­¤è„šæœ¬ã€‚
7ã€æ‰€æœ‰ç›´æŽ¥æˆ–é—´æŽ¥ä½¿ç”¨ã€æŸ¥çœ‹æ­¤è„šæœ¬çš„äººå‡åº”è¯¥ä»”ç»†é˜…è¯»æ­¤å£°æ˜Žã€‚æœ¬äººä¿ç•™éšæ—¶æ›´æ”¹æˆ–è¡¥å……æ­¤å£°æ˜Žçš„æƒåˆ©ã€‚ä¸€æ—¦æ‚¨ä½¿ç”¨æˆ–å¤åˆ¶äº†æ­¤è„šæœ¬ï¼Œå³è§†ä¸ºæ‚¨å·²æŽ¥å—æ­¤å…è´£å£°æ˜Žã€‚

  ðŸ“Œä¸å®šæœŸæ›´æ–°å„ç§ç­¾åˆ°ã€æœ‰è¶£çš„è„šæœ¬ï¼Œæ¬¢è¿ŽstarðŸŒŸ

  *************************
  ã€é…ç½®æ­¥éª¤ï¼Œè¯·è®¤çœŸé˜…è¯»ã€‘
  *************************
  1. æ ¹æ®ä½ å½“å‰çš„è½¯ä»¶ï¼Œé…ç½®å¥½srciptã€‚ Tips:ç”±äºŽæ˜¯è¿œç¨‹æ–‡ä»¶ï¼Œè®°å¾—é¡ºä¾¿æ›´æ–°æ–‡ä»¶ã€‚
  2. æ‰“å¼€å¾®åšAPPï¼Œâ€æˆ‘çš„â€œï¼Œ â€è¶…è¯ç¤¾åŒºâ€œï¼Œ â€åº•éƒ¨æ --æˆ‘çš„â€œï¼Œ â€å…³æ³¨â€œï¼Œ å¼¹å‡ºé€šçŸ¥ï¼Œæç¤ºèŽ·å–å·²å…³æ³¨è¶…è¯é“¾æŽ¥æˆåŠŸã€‚
  3. ç‚¹è¿›ä¸€ä¸ªè¶…è¯é¡µé¢ï¼Œæ‰‹åŠ¨ç­¾åˆ°ä¸€æ¬¡ï¼Œå¼¹å‡ºé€šçŸ¥ï¼Œæç¤ºèŽ·å–è¶…è¯ç­¾åˆ°é“¾æŽ¥æˆåŠŸã€‚ è‹¥ä¹‹å‰æ‰€æœ‰å·²ç»ç­¾åˆ°ï¼Œè¯·å…³æ³¨ä¸€ä¸ªæ–°è¶…è¯è¿›è¡Œç­¾åˆ°ã€‚
  4. ç‚¹å¼€åº•éƒ¨æ â€œå…³æ³¨â€ï¼Œä¸Šé¢åˆ‡æ¢åˆ°â€œå…³æ³¨â€ï¼Œä»Žä¸‹å¾€ä¸Šæ»‘ï¼Œæç¤ºèŽ·å–è¶…è¯ç­¾åˆ°çŠ¶æ€æˆåŠŸã€‚ï¼ˆå¦‚æžœ$.check_firstè®¾ä¸ºfalseåˆ™æ­¤æ­¥éª¤ä¸éœ€è¦ï¼Œéœ€å°†è„šæœ¬æ”¾åœ¨æœ¬åœ°ä¿®æ”¹å‚æ•°ã€‚ï¼‰
  5. å›žåˆ°quanxç­‰è½¯ä»¶ï¼Œå…³æŽ‰èŽ·å–cookieçš„rewriteã€‚ï¼ˆloonæ˜¯å…³æŽ‰èŽ·å–cookieçš„è„šæœ¬ï¼‰
  æç¤ºï¼šå¦‚æžœè¶…è¯è¿‡å¤šæç¤ºé¢‘ç¹ï¼Œå¯é—´éš”åŠä¸ªå°æ—¶ä»¥ä¸Šå†æ‰§è¡Œä¸€æ¬¡ã€‚

   ***************************************
  ã€boxjs è®¢é˜…ï¼Œ å¯ä»¥è®©ä½ ä¿®æ”¹è¿œç¨‹æ–‡ä»¶é‡Œé¢çš„å˜é‡ã€‘
   ***************************************
   boxè®¢é˜…é“¾æŽ¥ï¼šhttps://raw.githubusercontent.com/toulanboy/scripts/master/toulanboy.boxjs.json
   è®¢é˜…åŽï¼Œå¯ä»¥åœ¨boxé‡Œé¢è¿›è¡Œ cookieæ¸…ç©ºã€é€šçŸ¥ä¸ªæ•°ã€ç­¾åˆ°å»¶è¿Ÿ ç­‰è®¾ç½®.

  *************************
  ã€Surge 4.2+ è„šæœ¬é…ç½®ã€‘
  *************************
  å¾®åšè¶…è¯cookieèŽ·å– = type=http-request,pattern=^https?://m?api\.weibo\.c(n|om)\/2\/(cardlist|page\/button),script-path=https://raw.githubusercontent.com/evilbutcher/Quantumult_X/master/check_in/weibo/weibotalk.cookie.js,requires-body=false
  å¾®åšè¶…è¯ = type=cron,cronexp="5 0  * * *",script-path=https://raw.githubusercontent.com/evilbutcher/Quantumult_X/master/check_in/weibo/weibotalk.js,wake-system=true,timeout=600

  [MITM]
  hostname = api.weibo.cn

  *************************
  ã€Loon 2.1+ è„šæœ¬é…ç½®ã€‘
  *************************
  [script]
  cron "5 0 * * *" script-path=https://raw.githubusercontent.com/evilbutcher/Quantumult_X/master/check_in/weibo/weibotalk.js, timeout=600, tag=å¾®åšè¶…è¯
  http-request ^https?://m?api\.weibo\.c(n|om)\/2\/(cardlist|page\/button) script-path=https://raw.githubusercontent.com/evilbutcher/Quantumult_X/master/check_in/weibo/weibotalk.cookie.js,requires-body=false, tag=å¾®åšè¶…è¯cookieèŽ·å–
  
  [MITM]
  hostname = api.weibo.cn

  *************************
  ã€ QX 1.0.10+ è„šæœ¬é…ç½® ã€‘ 
  *************************
  [rewrite_local]
  ^https?://m?api\.weibo\.c(n|om)\/2\/(cardlist|page\/button) url script-request-header https://raw.githubusercontent.com/evilbutcher/Quantumult_X/master/check_in/weibo/weibotalk.cookie.js

  [task]
  5 0 * * * https://raw.githubusercontent.com/evilbutcher/Quantumult_X/master/check_in/weibo/weibotalk.js, tag=å¾®åšè¶…è¯

  [MITM]
  hostname = api.weibo.cn

*********/

const $ = new Env(`weibo`);
const tokenurl = "evil_tokenurl";
const tokencheckinurl = "evil_tokencheckinurl";
const tokensinceurl = "evil_tokensinceurl";
const tokensinceheaders = "evil_tokensinceheaders";
const tokenheaders = "evil_tokenheaders";
const tokencheckinheaders = "evil_tokencheckinheaders";

if (
  $request &&
  $request.method != "OPTIONS" &&
  $request.url.match(/\_\-\_myfollow\&need\_head\_cards/) &&
  $request.url.match(/cardlist/)
) {
  const listurl = $request.url;
  $.log(listurl);
  const listheaders = JSON.stringify($request.headers);
  $.setdata(listurl, tokenurl);
  $.setdata(listheaders, tokenheaders);
  //$.msg("å¾®åšè¶…è¯", "", "èŽ·å–å·²å…³æ³¨è¶…è¯åˆ—è¡¨æˆåŠŸâœ…");
  $.msg("å¾®åšè¶…è¯", "âœ…èŽ·å–å·²å…³æ³¨è¶…è¯åˆ—è¡¨æˆåŠŸ", "âœ¨æŽ¥ä¸‹æ¥ï¼Œè¯·ç‚¹è¿›ä¸€ä¸ªè¶…è¯è¿›è¡Œç­¾åˆ°ã€‚å¦‚æžœæ²¡æœ‰éœ€è¦ç­¾åˆ°çš„è¶…è¯ï¼Œè¯·å…³æ³¨æ–°çš„è¿›è¡Œç­¾åˆ°ã€‚")
} else if (
  $request &&
  $request.method != "OPTIONS" &&
  $request.url.match(/active\_checkin/) &&
  $request.url.match(/page\/button/)
) {
  const checkinurl = $request.url;
  $.log(checkinurl);
  const checkinheaders = JSON.stringify($request.headers);
  $.setdata(checkinurl, tokencheckinurl);
  $.setdata(checkinheaders, tokencheckinheaders);
  //$.msg("å¾®åšè¶…è¯", "", "èŽ·å–è¶…è¯ç­¾åˆ°é“¾æŽ¥æˆåŠŸðŸŽ‰");
  $.msg("å¾®åšè¶…è¯", "ðŸŽ‰èŽ·å–è¶…è¯ç­¾åˆ°é“¾æŽ¥æˆåŠŸ", `ðŸš¨è¯·å›žåˆ°åº•éƒ¨æ â€œå…³æ³¨â€ï¼Œä¸Šé¢åˆ‡æ¢åˆ°â€œå…³æ³¨â€ï¼Œä»Žä¸‹å¾€ä¸Šæ»‘ï¼ŒèŽ·å–ç­¾åˆ°çŠ¶æ€ã€‚å¦‚æžœ$.check_firstè®¾ä¸ºfalseåˆ™CookieèŽ·å–å·²å®Œæˆï¼Œå¯ä»¥å…³é—­èŽ·å–Cookieçš„è„šæœ¬æˆ–é‡å†™ã€‚`)
} else if (
  $request &&
  $request.method != "OPTIONS" &&
  $request.url.match(/manage/) &&
  $request.url.match(/since\_id/)
) {
  const sinceurl = $request.url;
  $.log(sinceurl);
  const sinceheaders = JSON.stringify($request.headers);
  $.setdata(sinceurl, tokensinceurl);
  $.setdata(sinceheaders, tokensinceheaders);
  //$.msg("å¾®åšè¶…è¯", "", "èŽ·å–è¶…è¯ç­¾åˆ°çŠ¶æ€æˆåŠŸðŸ†—");
  $.msg("å¾®åšè¶…è¯", "ðŸ†—èŽ·å–è¶…è¯ç­¾åˆ°çŠ¶æ€æˆåŠŸ", `CookieèŽ·å–å…¨éƒ¨å®Œæˆï¼Œå¯ä»¥å…³é—­èŽ·å–Cookieçš„è„šæœ¬æˆ–é‡å†™ã€‚`)
}

$.done();

//chavyleung
function Env(t) {
  (this.name = t),
    (this.logs = []),
    (this.isSurge = () => "undefined" != typeof $httpClient),
    (this.isQuanX = () => "undefined" != typeof $task),
    (this.log = (...t) => {
      (this.logs = [...this.logs, ...t]),
        t ? console.log(t.join("\n")) : console.log(this.logs.join("\n"));
    }),
    (this.msg = (t = this.name, s = "", i = "") => {
      this.isSurge() && $notification.post(t, s, i),
        this.isQuanX() && $notify(t, s, i),
        this.log(
          "==============\ud83d\udce3\u7cfb\u7edf\u901a\u77e5\ud83d\udce3=============="
        ),
        t && this.log(t),
        s && this.log(s),
        i && this.log(i);
    }),
    (this.getdata = t =>
      this.isSurge()
        ? $persistentStore.read(t)
        : this.isQuanX()
        ? $prefs.valueForKey(t)
        : void 0),
    (this.setdata = (t, s) =>
      this.isSurge()
        ? $persistentStore.write(t, s)
        : this.isQuanX()
        ? $prefs.setValueForKey(t, s)
        : void 0),
    (this.get = (t, s) => this.send(t, "GET", s)),
    (this.wait = (t, s = t) => i =>
      setTimeout(() => i(), Math.floor(Math.random() * (s - t + 1) + t))),
    (this.post = (t, s) => this.send(t, "POST", s)),
    (this.send = (t, s, i) => {
      if (this.isSurge()) {
        const e = "POST" == s ? $httpClient.post : $httpClient.get;
        e(t, (t, s, e) => {
          s && ((s.body = e), (s.statusCode = s.status)), i(t, s, e);
        });
      }
      this.isQuanX() &&
        ((t.method = s),
        $task.fetch(t).then(
          t => {
            (t.status = t.statusCode), i(null, t, t.body);
          },
          t => i(t.error, t, t)
        ));
    }),
    (this.done = (t = {}) => $done(t));
}
